<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ricerca Giocatore - L&K Tool</title>
    
    <script src="https://re-panza.github.io/lk_tool/version.js"></script>
    <script>
      document.write(`<link rel="manifest" href="https://re-panza.github.io/lk_tool/manifest.json?v=${APP_VERSION}">`);
    </script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #111c33;
            --muted: #93a4c7;
            --text: #e8eefc;
            --accent: #60a5fa;
            --border: rgba(255, 255, 255, .10);
            --success: #34d399;
            --danger: #f87171;
        }

        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; text-align: center; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto 20px auto; }
        .btn-home { text-decoration: none; color: var(--accent); font-size: 14px; font-weight: 600; }

        .container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h2 { margin: 0 0 10px 0; font-size: 22px; }
        #stato { font-size: 12px; color: var(--muted); margin-bottom: 20px; }

        textarea { width: 100%; height: 100px; padding: 12px; margin: 15px 0; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: #fff; box-sizing: border-box; resize: none; font-size: 14px; }
        
        #errorBanner { display: none; background: rgba(248, 113, 113, 0.1); color: var(--danger); padding: 12px; border-radius: 10px; border: 1px solid var(--danger); margin-bottom: 15px; font-size: 13px; font-weight: 600; }

        .btn-cerca { width: 100%; padding: 15px; background: var(--accent); border: none; font-weight: 700; font-size: 16px; border-radius: 12px; cursor: pointer; color: #fff; margin-bottom: 10px; }
        
        .btn-export-box { display: flex; gap: 10px; margin: 20px 0; display: none; }
        .btn-exp { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
        .btn-sel { background: var(--success); color: #064e3b; }
        .btn-all { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid var(--border); }

        /* Gruppi Giocatori */
        .player-group { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; text-align: left; }
        .player-header { background: rgba(255,255,255,0.02); color: var(--accent); padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .player-content { display: none; padding: 10px; background: rgba(0,0,0,0.1); }
        .player-header.active + .player-content { display: block; }

        /* Card Habitat */
        .castello-card { background: rgba(255,255,255,0.02); padding: 12px; margin-bottom: 8px; border-radius: 10px; border-left: 4px solid var(--accent); display: flex; align-items: center; gap: 12px; }
        .hab-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--success); }
        .castello-nome { font-weight: 700; color: #fff; display: block; font-size: 15px; }
        .castello-info { font-size: 13px; color: var(--muted); margin-top: 2px; }
        .castello-link { color: var(--accent); text-decoration: none; font-family: monospace; font-size: 12px; display: block; margin-top: 6px; opacity: 0.7; }

        .paypal-footer { margin-top: 40px; text-align: center; border-top: 1px solid var(--border); padding-top: 24px; }
        .paypal-button { display: inline-flex; align-items: center; gap: 8px; background: #ffc439; color: #000; padding: 10px 20px; border-radius: 100px; text-decoration: none; font-weight: 700; font-size: 14px; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="https://re-panza.github.io/lk_tool/index.html" class="btn-home">‚Üê Home</a>
        <div style="font-size: 10px; color: var(--muted);">v<script>document.write(APP_VERSION)</script></div>
    </div>

    <div class="container">
        <h2>üîç Intelligence Mondiale</h2>
        <div id="stato">Caricamento database...</div>
        
        <div id="errorBanner">‚ö†Ô∏è Incolla 'Nome giocatore:' e il link 'l+k://player'</div>

        <textarea id="inputText" placeholder="Incolla qui il profilo...&#10;Nome giocatore: Re Panza&#10;l+k://player?605&327"></textarea>
        
        <button class="btn-cerca" onclick="cerca()">AVVIA RICERCA</button>

        <div id="export-buttons" class="btn-export-box">
            <button class="btn-exp btn-sel" onclick="exportReport(true)">üì• SELEZIONATI</button>
            <button class="btn-exp btn-all" onclick="exportReport(false)">üì• TUTTI</button>
        </div>

        <div id="risultati"></div>
    </div>

    <footer class="paypal-footer">
        <p style="font-size:12px; color:var(--muted); margin-bottom:15px;">Offrimi un caff√® se il tool ti √® utile!</p>
        <a href="https://www.paypal.me/AmedeoPanza" target="_blank" class="paypal-button">PayPal</a>
    </footer>

    <script>
        let db = [];

        async function loadDB() {
            const stato = document.getElementById('stato');
            try {
                const url = 'https://re-panza.github.io/lk_tool/mondo327.json?v=' + Date.now();
                const risposta = await fetch(url);
                db = await risposta.json();
                stato.innerHTML = `‚úÖ Database Pronto (${db.length.toLocaleString()} castelli)`;
            } catch (err) {
                stato.innerHTML = "‚ùå Errore caricamento database.";
            }
        }
        loadDB();

        function getTipoHabitat(t) {
            const tipo = String(t).trim();
            if (tipo === "0") return "Castello";
            if (tipo === "2") return "Fortezza";
            if (tipo === "4") return "Citt√†";
            return isNaN(tipo) ? tipo : "Metropoli";
        }

        function cerca() {
            const input = document.getElementById('inputText').value;
            const resDiv = document.getElementById('risultati');
            const exportDiv = document.getElementById('export-buttons');
            const errorBanner = document.getElementById('errorBanner');
            
            resDiv.innerHTML = ""; 
            errorBanner.style.display = "none";

            if (!input.toLowerCase().includes("nome giocatore:") || !input.includes("l+k://player?")) {
                errorBanner.style.display = "block";
                exportDiv.style.display = "none";
                return;
            }

            const chunks = input.split(/Nome giocatore:/i).filter(c => c.trim() !== "");
            
            chunks.forEach(chunk => {
                const linee = chunk.trim().split('\n');
                const nomePlayer = linee[0].trim();
                const idMatch = chunk.match(/player\?(\d+)/);

                if (idMatch) {
                    const pID = parseInt(idMatch[1]);
                    let castelli = db.filter(c => c.p === pID);
                    castelli.sort((a, b) => (b.pt || 0) - (a.pt || 0));
                    renderPlayerGroup(nomePlayer, castelli, resDiv);
                    exportDiv.style.display = "flex";
                }
            });
        }

        function renderPlayerGroup(nome, castelli, container) {
            const group = document.createElement('div');
            group.className = 'player-group';
            
            let itemsHtml = castelli.map((c, i) => {
                const tipo = getTipoHabitat(c.t);
                const link = `l+k://coordinates?${c.x}&${c.y}&327`;
                const punti = (c.pt || 0).toLocaleString();
                
                return `
                    <div class="castello-card">
                        <input type="checkbox" class="hab-check" 
                               data-nome="${c.n}" data-tipo="${tipo}" 
                               data-punti="${punti}" data-link="${link}">
                        <div style="flex-grow:1">
                            <span class="castello-nome">${i+1}. ${c.n || 'Senza Nome'}</span>
                            <span class="castello-info"><b>${tipo}</b> ‚Ä¢ ${punti} pt</span>
                            <a href="${link}" class="castello-link">${link}</a>
                        </div>
                    </div>`;
            }).join('');

            group.innerHTML = `
                <div class="player-header" onclick="this.classList.toggle('active')">
                    <span>üë§ ${nome} (${castelli.length})</span>
                    <span>‚ñº</span>
                </div>
                <div class="player-content">
                    ${castelli.length > 0 ? itemsHtml : '<p style="padding:15px; color:var(--muted); font-size:13px;">Nessun dato trovato.</p>'}
                </div>
            `;
            container.appendChild(group);
        }

        function exportReport(soloSelezionati) {
            const checkboxes = document.querySelectorAll('.hab-check');
            let testo = "--- REPORT INTELLIGENCE L&K ---\n\n";
            let count = 0;

            checkboxes.forEach(cb => {
                if (!soloSelezionati || cb.checked) {
                    // RIMOSSE COORDINATE ANCHE DA QUI (rimane solo il link)
                    testo += `${cb.dataset.tipo}: ${cb.dataset.nome} (${cb.dataset.punti} pt)\nLink: ${cb.dataset.link}\n\n`;
                    count++;
                }
            });

            if (count === 0) return alert("Nessuna selezione!");

            const blob = new Blob([testo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Report_Intelligence.txt`;
            a.click();
        }
    </script>
</body>
</html>
