<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Giocatore - L&K Tool</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        .nav-home { display: inline-block; margin-bottom: 20px; color: #ffcc00; text-decoration: none; font-weight: bold; border: 1px solid #ffcc00; padding: 8px 15px; border-radius: 5px; transition: 0.3s; }
        .nav-home:hover { background: #ffcc00; color: #000; }
        .container { max-width: 600px; margin: 0 auto; background: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border: 1px solid #333; }
        h2 { color: #ffcc00; margin-top: 0; }
        textarea { width: 100%; height: 80px; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #2b2b2b; color: #fff; box-sizing: border-box; resize: none; font-family: monospace; }
        textarea:focus { outline: none; border-color: #ffcc00; }
        .btn-cerca { width: 100%; padding: 15px; background: #ffcc00; border: none; font-weight: bold; font-size: 1.1em; border-radius: 8px; cursor: pointer; color: #000; transition: transform 0.2s; }
        .btn-cerca:hover { background: #e6b800; transform: translateY(-2px); }
        #stato { font-size: 0.9em; margin-bottom: 10px; color: #888; }
        .risultati-box { margin-top: 25px; text-align: left; }
        .castello-card { background: #252525; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #ffcc00; word-break: break-all; }
        .castello-nome { font-weight: bold; color: #fff; margin-bottom: 3px; display: block; }
        .castello-info { font-size: 0.85em; color: #bbb; margin-bottom: 8px; }
        .castello-link { color: #00ccff; text-decoration: none; font-family: monospace; font-size: 0.95em; display: block; margin-top: 5px; }
        .castello-link:hover { text-decoration: underline; }
        .footer { margin-top: 30px; font-size: 0.8em; color: #666; }
        .paypal-btn { color: #ffcc00; text-decoration: none; font-weight: bold; }
        /* Stile per il menu a tendina */
.player-group {
    margin-bottom: 10px;
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
}
.player-header {
    background: #2b2b2b;
    color: #ffcc00;
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.player-header:hover { background: #333; }
.player-content {
    display: none; /* Chiuso di default */
    padding: 10px;
    background: #1e1e1e;
}
.player-header.active + .player-content {
    display: block;
}
    </style>
</head>
<body>

    <a href="https://re-panza.github.io/lk_tool/" class="nav-home">‚¨Ö Torna alla Home</a>

    <div class="container">
        <h2>üîç Intelligence Mondiale</h2>
        <div id="stato">Connessione al database...</div>
        
        <textarea id="inputText" placeholder="Incolla profilo Giocatore o Alleanza (l+k://...)"></textarea>
        
        <button class="btn-" onclick="cerca()">AVVIA RICERCA</button>

        <div id="risultati" class="risultati-box"></div>
    </div>

    <div class="footer">
        L&K Tool by Re Panza<br><br>
        <a href="https://www.paypal.com/paypalme/filippocutrupi" target="_blank" class="paypal-btn">‚òï Offrimi un caff√® su PayPal</a>
    </div>

    <script>
        let db = [];

        async function loadDB() {
            const stato = document.getElementById('stato');
            try {
                const url = 'https://re-panza.github.io/lk_tool/mondo327.json?v=' + Date.now();
                const risposta = await fetch(url);
                if (!risposta.ok) throw new Error("File non trovato");
                const testoGrezzo = await risposta.text();
                const inizioJson = testoGrezzo.indexOf('[');
                const fineJson = testoGrezzo.lastIndexOf(']');
                if (inizioJson === -1) {
                    stato.innerHTML = "‚ö†Ô∏è Database ancora vuoto.";
                    return;
                }
                db = JSON.parse(testoGrezzo.substring(inizioJson, fineJson + 1));
                stato.innerHTML = `‚úÖ Database Pronto (${db.length.toLocaleString()} castelli)`;
                stato.style.color = "#4caf50";
            } catch (err) {
                stato.innerHTML = "‚ùå Errore database.";
                stato.style.color = "#f44336";
            }
        }
        loadDB();

     function cerca() {
    const input = document.getElementById('inputText').value;
    const resDiv = document.getElementById('risultati');
    resDiv.innerHTML = ""; 

    // Estrazione ID
    const playerIDs = [...input.matchAll(/player\?(\d+)/g)].map(m => parseInt(m[1]));
    const allianceIDs = [...input.matchAll(/alliance\?(\d+)/g)].map(m => parseInt(m[1]));

    if (playerIDs.length === 0 && allianceIDs.length === 0) {
        alert("‚ö†Ô∏è Incolla un link valido!");
        return;
    }

    // Filtro dati
    let filtrati = db.filter(c => playerIDs.includes(c.p) || allianceIDs.includes(c.a));

    if (filtrati.length === 0) {
        resDiv.innerHTML = `<p style="text-align:center;">Nessun dato trovato. Lo scanner ha gi√† coperto questa zona?</p>`;
        return;
    }

    // Raggruppamento
    const raggruppato = filtrati.reduce((acc, c) => {
        if (!acc[c.p]) {
            // Se pn non esiste (vecchi dati), usa l'ID
            acc[c.p] = { 
                nome: c.pn ? c.pn : "Giocatore " + c.p, 
                castelli: [] 
            };
        }
        acc[c.p].castelli.push(c);
        return acc;
    }, {});

    let html = `<button class="btn-cerca" style="background:#2196F3; color:white; margin-bottom:20px;" onclick="exportReport()">üì• ESPORTA REPORT .TXT</button>`;

    Object.keys(raggruppato).forEach(pID => {
        const player = raggruppato[pID];
        player.castelli.sort((a, b) => (b.pt || 0) - (a.pt || 0));

        // Usiamo innerText per gestire i caratteri speciali in sicurezza
        html += `
            <div class="player-group">
                <div class="player-header" onclick="this.classList.toggle('active')">
                    <span>üë§ ${player.nome} (${player.castelli.length} habitat)</span>
                    <span>‚ñº</span>
                </div>
                <div class="player-content">`;

        player.castelli.forEach((c, index) => {
            const nomeHabitat = c.n ? c.n : "Habitat";
            html += `
                <div class="castello-card">
                    <span class="castello-nome">${index + 1}. ${nomeHabitat}</span>
                    <div class="castello-info"><b>${c.t || "Castello"}</b> ‚Ä¢ ${(c.pt || 0).toLocaleString()} pt</div>
                    <a href="l+k://coordinate?${c.x}&${c.y}&327" class="castello-link">l+k://coordinates?${c.x},${c.y}&327</a>
                </div>`;
        });

        html += `</div></div>`;
    });

    resDiv.innerHTML = html;
}
        function exportReport() {
            const container = document.getElementById('risultati');
            let testoExport = "--- REPORT INTELLIGENCE L&K ---\n\n";
            
            // Seleziona tutti i blocchi giocatori e i loro castelli
            const cards = container.querySelectorAll('.castello-card');
            const headers = container.querySelectorAll('h3');
            
            let currentHeaderIndex = 0;
            let counter = 1;

            // Logica semplice per estrarre il testo pulito
            const cardsArray = Array.from(container.children);
            
            cardsArray.forEach(el => {
                if (el.tagName === 'DIV' && el.style.textAlign === 'left') {
                    testoExport += `\n${el.innerText}\n${"=".repeat(20)}\n`;
                    counter = 1;
                }
                if (el.classList.contains('castello-card')) {
                    const nome = el.querySelector('.castello-nome').innerText;
                    const info = el.querySelector('.castello-info').innerText;
                    const link = el.querySelector('.castello-link').innerText;
                    testoExport += `${nome} | ${info}\n Link: ${link}\n\n`;
                }
            });

            // Creazione file e download
            const blob = new Blob([testoExport], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Report_Intelligence_${new Date().toLocaleDateString()}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
