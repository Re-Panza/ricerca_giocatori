<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://re-panza.github.io/lk_tool/icona.png">
    <title>Ricerca Giocatore</title>
    <script src="https://re-panza.github.io/lk_tool/version.js"></script>
    <script>document.write(`<link rel="manifest" href="https://re-panza.github.io/lk_tool/manifest.json?v=${APP_VERSION}">`);</script>
    <style>
        :root { --bg:#0f172a; --card:#111c33; --muted:#93a4c7; --text:#e8eefc; --accent:#60a5fa; --border:rgba(255,255,255,.10); --success:#34d399; --danger:#ef4444; }
        * { box-sizing:border-box; }
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:radial-gradient(1200px 600px at 20% 0%,rgba(96,165,250,.25),transparent 60%),radial-gradient(1000px 500px at 90% 10%,rgba(52,211,153,.18),transparent 55%),var(--bg); color:var(--text); padding:env(safe-area-inset-top,20px) 20px 40px 20px; user-select:none; }
        .container { max-width:500px; margin:0 auto; background:rgba(17,28,51,.8); backdrop-filter:blur(12px); padding:32px 24px; border-radius:24px; border:1px solid var(--border); box-shadow:0 20px 50px rgba(0,0,0,.3); }
        .nav-header { max-width:500px; margin:0 auto 20px auto; display:flex; }
        .btn-home { text-decoration:none; color:var(--accent); font-weight:700; display:inline-flex; align-items:center; gap:8px; font-size:16px; }
        .page-title h2 { font-size:24px; font-weight:800; color:#fff; margin:0 0 10px 0; }
        textarea { width:100%; height:140px; padding:16px; margin-bottom:20px; border-radius:16px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--text); outline:none; font-size:16px; resize:none; user-select:text; }
        textarea:focus { border-color:var(--accent); }
        .btn-cerca { width:100%; padding:16px; background:var(--accent); border:none; font-weight:800; font-size:17px; border-radius:16px; cursor:pointer; color:#0f172a; margin-bottom:12px; }
        .btn-export-box { display:none; gap:12px; margin-top:10px; }
        .btn-exp { flex:1; padding:14px; border-radius:14px; font-weight:700; cursor:pointer; font-size:14px; border:1px solid var(--border); }
        .btn-sel { background:rgba(52,211,153,.1); color:var(--success); border-color:rgba(52,211,153,.3); }
        .btn-all { background:rgba(255,255,255,.05); color:var(--muted); }
        #risultati { margin-top:24px; }
        .player-group { margin-bottom:16px; border:1px solid var(--border); border-radius:18px; overflow:hidden; background:rgba(255,255,255,.02); }
        .player-header { padding:18px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:16px; color:var(--accent); }
        .player-content { display:none; padding:12px; background:rgba(0,0,0,0.2); border-top:1px solid var(--border); }
        .castello-card { background:rgba(255,255,255,.03); padding:14px; margin-bottom:10px; border-radius:14px; border:1px solid var(--border); display:flex; align-items:center; gap:14px; }
        .hab-check { width:20px; height:20px; cursor:pointer; accent-color:var(--accent); }
        .castello-nome { font-weight:700; color:#fff; display:block; font-size:16px; }
        .castello-link { color:var(--accent); text-decoration:none; font-family:monospace; font-size:12px; display:block; margin-top:8px; opacity:0.6; cursor:pointer; }
        
        .paypal-footer { text-align:center; margin-top:60px; padding:30px 20px; border-top:1px solid rgba(255,255,255,0.1); }
        .paypal-link { text-decoration:none; font-weight:700; font-size:14px; display:inline-flex; align-items:center; gap:10px; transition:all 0.3s ease; color:#fff !important; background:#0070ba; padding:12px 28px; border-radius:50px; box-shadow:0 4px 15px rgba(0,112,186,0.3); border:none; }
        .paypal-link:hover { background:#005ea6; transform:translateY(-2px); }
        
        #ai-assistant-container { position:fixed; bottom:20px; right:20px; z-index:9999; }
        #ai-button { width:70px; height:70px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:2px solid var(--accent); overflow:hidden; }
        #ai-button img { width:100%; height:100%; object-fit:cover; }
        #ai-window { display:none; position:absolute; bottom:85px; right:0; width:85vw; max-width:320px; background:var(--card); border:1px solid var(--accent); border-radius:20px; padding:15px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
        .ai-header { color:var(--accent); font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:5px; }
        .ai-input-area { display:flex; gap:5px; border-top:1px solid var(--border); padding-top:10px; }
        #ai-input { flex:1; background:#000; border:1px solid var(--border); color:#fff; border-radius:5px; padding:8px; font-size:12px; }
        #ai-send-btn { background:var(--accent); border:none; border-radius:5px; padding:5px 15px; cursor:pointer; font-weight:bold; color:#000; }
    </style>
</head>
<body>
    <div class="nav-header"><a href="https://re-panza.github.io/lk_tool/index.html" class="btn-home">üè† Home</a></div>
    <div class="page-title"><h2>üîç Ricerca</h2></div>

    <div class="container">
        <textarea id="inputText" placeholder="Incolla link..."></textarea>
        <button class="btn-cerca" onclick="cerca()">CERCA</button>
        <div id="export-buttons" class="btn-export-box">
            <button class="btn-exp btn-sel" onclick="exportReport(true)">SELEZIONE</button>
            <button class="btn-exp btn-all" onclick="exportReport(false)">TUTTI</button>
        </div>
        <div id="risultati"></div>
    </div>

    <footer class="paypal-footer"><a href="https://paypal.me/Longo11" target="_blank" class="paypal-link">‚òï PayPal</a></footer>

    <div id="ai-assistant-container"><div id="ai-window"><div class="ai-header"><span>üëë Re Panza</span><span onclick="toggleAI()" style="cursor:pointer">√ó</span></div><div id="ai-content"><p>Ciao!</p></div><div class="ai-input-area"><input type="text" id="ai-input" placeholder="..."><button id="ai-send-btn" onclick="chiediAlRe()">Invia</button></div></div><div id="ai-button" onclick="toggleAI()"><img src="https://re-panza.github.io/lk_tool/re-panza-ai.png" alt="AI"></div></div>

    <script src="https://re-panza.github.io/lk_tool/common.js"></script>
    <script src="https://re-panza.github.io/re-panza-core/re_panza_brain.js"></script>

    <script>
        let dbCastelli = [], dbNomiMap = {}, mondoCaricatoAttualmente = "";

        async function cerca() {
            const input = document.getElementById('inputText').value;
            const resDiv = document.getElementById('risultati'), exportDiv = document.getElementById('export-buttons');
            resDiv.innerHTML = ""; exportDiv.style.display = "none";

            const matches = [...input.matchAll(/(?:l\+k:\/\/|https?:\/\/.*?)player\?(\d+)&(\d+)/gi)];
            const allyMatches = [...input.matchAll(/(?:l\+k:\/\/|https?:\/\/.*?)alliance\?(\d+)&(\d+)/gi)];
            
            if (!matches.length && !allyMatches.length) return alert("Link non valido!");

            const pIds = new Set(), aIds = new Set();
            let w = matches[0]?.[2] || allyMatches[0]?.[2];
            matches.forEach(m => pIds.add(parseInt(m[1])));
            allyMatches.forEach(m => aIds.add(parseInt(m[1])));

            if (mondoCaricatoAttualmente !== w) {
                const data = await LK_API.fetchWorldData(w);
                if(!data) return;
                dbCastelli = data.db; dbNomiMap = data.names;
                mondoCaricatoAttualmente = w;
            }

            let found = dbCastelli.filter(c => pIds.has(c.p) || aIds.has(c.a));
            if (!found.length) return resDiv.innerHTML = "<p>Nessun castello trovato.</p>";

            const groups = {};
            found.forEach(c => { if(!groups[c.p]) groups[c.p]=[]; groups[c.p].push(c); });

            Object.keys(groups).forEach(pid => {
                const castelli = groups[pid].sort((a,b) => b.pt - a.pt);
                const pts = castelli.reduce((a,b)=>a+b.pt,0);
                const nome = dbNomiMap[pid] || "ID "+pid;
                const status = castelli[0].i ? "‚ö†Ô∏è INATTIVO" : "‚úÖ ATTIVO";
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'player-group';
                let html = castelli.map((c, i) => {
                    let type = c.t==0?"Castello":c.t==2?"Fortezza":c.t==4?"Citt√†":"Metro";
                    let link = `l+k://coordinates?${c.x},${c.y}&${w}`;
                    return `<div class="castello-card">
                        <input type="checkbox" class="hab-check" data-link="${link}" data-info="${type} ${c.n}">
                        <div style="flex-grow:1"><span class="castello-nome">${i+1}. ${c.n}</span><span class="castello-info">${type} ‚Ä¢ ${c.pt} pt</span><a href="${link}" class="castello-link">${link}</a></div>
                    </div>`;
                }).join('');

                groupDiv.innerHTML = `<div class="player-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'"><span>üë§ ${nome} (${pts} pt) ${status}</span><span>‚ñº</span></div><div class="player-content">${html}</div>`;
                resDiv.appendChild(groupDiv);
            });
            exportDiv.style.display = "flex";
        }

        function exportReport(onlySel) {
            let txt = "REPORT L&K\n\n";
            document.querySelectorAll('.hab-check').forEach(cb => {
                if(!onlySel || cb.checked) txt += `${cb.dataset.info}\n${cb.dataset.link}\n\n`;
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
            a.download = "Report.txt"; a.click();
        }
    </script>
</body>
</html>
