<script>
let databaseLocale = null;

async function caricaDatabase() {
    const divRisultati = document.getElementById('risultati');
    divRisultati.innerHTML = "<p style='color:#ffcc00;'>‚ö° Connessione al database L&K...</p>";
    
    try {
        // Usiamo l'URL RAW di GitHub che non ha blocchi CORS
        const urlJSON = 'https://raw.githubusercontent.com/re-panza/lk_tool/main/mondo327.json?v=' + Date.now();
        
        const risposta = await fetch(urlJSON);
        if (!risposta.ok) throw new Error("Server non raggiungibile");
        
        databaseLocale = await risposta.json();
        divRisultati.innerHTML = "<p style='color:#00ff00;'>‚úÖ Database Mondo 327 Pronto!</p>";
    } catch (errore) {
        divRisultati.innerHTML = "<p style='color:red;'>‚ùå Errore: Il database non risponde.<br><small>Assicurati che il file mondo327.json esista nella repo lk_tool.</small></p>";
        console.error("Dettaglio errore:", errore);
    }
}

// Avvio immediato
caricaDatabase();

function analizza() {
    if (!databaseLocale) {
        alert("Sto ancora scaricando i dati, riprova tra un secondo...");
        return;
    }

    const input = document.getElementById('linkInput').value;
    const divRisultati = document.getElementById('risultati');
    
    // Estrae l'ID (prende i numeri dopo il ?)
    const regex = /player\?(\d+)/;
    const match = input.match(regex);

    if (!match) {
        divRisultati.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Formato link errato. Incolla il link del profilo giocatore.</p>";
        return;
    }

    const playerID = parseInt(match[1]);
    const castelliTrovati = databaseLocale.filter(c => c.p === playerID);

    if (castelliTrovati.length === 0) {
        divRisultati.innerHTML = `<p>Nessun castello trovato per l'ID <b>${playerID}</b>.</p>`;
        return;
    }

    let html = `<div style="text-align:center; padding:10px; border-bottom:1px solid #444; margin-bottom:15px;">
                    <h3 style="margin:0; color:#ffcc00;">Trovati ${castelliTrovati.length} castelli</h3>
                </div>`;
    
    castelliTrovati.forEach(c => {
        const deepLink = `l+k://coordinate?${c.x}&${c.y}&327`;
        html += `
            <div style="background:#333; padding:10px; margin-bottom:8px; border-radius:8px; border-left:4px solid #ffcc00;">
                <b style="font-size:1.1em;">${c.n}</b><br>
                <a href="${deepLink}" style="color:#00ccff; text-decoration:none;">üìç Coordinate: ${c.x}, ${c.y}</a>
            </div>
        `;
    });

    divRisultati.innerHTML = html;
    // Pulisce l'input per la prossima ricerca
    document.getElementById('linkInput').value = "";
}
</script>
