<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Giocatore - L&K Tool</title>
    <style>
        /* Stile Dark/Gold coerente con il resto del progetto */
        body { 
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
        }

        /* Bottone Home in alto */
        .nav-home {
            display: inline-block;
            margin-bottom: 20px;
            color: #ffcc00;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid #ffcc00;
            padding: 8px 15px;
            border-radius: 5px;
            transition: 0.3s;
        }
        .nav-home:hover { background: #ffcc00; color: #000; }

        /* Contenitore principale */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: #1e1e1e; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); 
            border: 1px solid #333;
        }

        h2 { color: #ffcc00; margin-top: 0; }
        
        /* Area di testo per incollare comodamente */
        textarea { 
            width: 100%; 
            height: 80px; 
            padding: 12px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
            background: #2b2b2b; 
            color: #fff; 
            box-sizing: border-box; 
            resize: none; /* Blocca il ridimensionamento */
            font-family: monospace;
        }
        textarea:focus { outline: none; border-color: #ffcc00; }

        /* Bottone Cerca */
        .btn-cerca { 
            width: 100%; 
            padding: 15px; 
            background: #ffcc00; 
            border: none; 
            font-weight: bold; 
            font-size: 1.1em;
            border-radius: 8px; 
            cursor: pointer; 
            color: #000; 
            transition: transform 0.2s;
        }
        .btn-cerca:hover { background: #e6b800; transform: translateY(-2px); }

        /* Stato del Database */
        #stato { font-size: 0.9em; margin-bottom: 10px; color: #888; }

        /* Stile dei Risultati */
        .risultati-box { margin-top: 25px; text-align: left; }
        
        .castello-card { 
            background: #252525; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border-left: 5px solid #ffcc00; 
            word-break: break-all; /* Per evitare che i link lunghi rompano la grafica */
        }
        
        .castello-nome { font-weight: bold; color: #fff; margin-bottom: 5px; display: block; }
        
        .castello-link { 
            color: #00ccff; 
            text-decoration: none; 
            font-family: monospace; 
            font-size: 0.95em; 
            display: block;
            margin-top: 5px;
        }
        .castello-link:hover { text-decoration: underline; }

        /* Footer PayPal */
        .footer { margin-top: 30px; font-size: 0.8em; color: #666; }
        .paypal-btn { color: #ffcc00; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <a href="https://re-panza.github.io/lk_tool/" class="nav-home">‚¨Ö Torna alla Home</a>

    <div class="container">
        <h2>üîç Intelligence Giocatori</h2>
        <div id="stato">Connessione al database...</div>
        
        <textarea id="inputText" placeholder="Incolla qui il profilo (es: Nome giocatore... l+k://player?...)"></textarea>
        
        <button class="btn-cerca" onclick="cerca()">TROVA CASTELLI</button>

        <div id="risultati" class="risultati-box"></div>
    </div>

    <div class="footer">
        L&K Tool by Re Panza<br>
        <br>
        <a href="https://www.paypal.com/paypalme/filippocutrupi" target="_blank" class="paypal-btn">‚òï Offrimi un caff√® su PayPal</a>
    </div>

    <script>
        let db = [];

        // 1. Caricamento Database
        async function loadDB() {
            const stato = document.getElementById('stato');
            try {
                const url = 'https://re-panza.github.io/lk_tool/mondo327.json';
                
                // Chiediamo al server le info sul file (per la data) e il contenuto (per i dati)
                const [respData, respInfo] = await Promise.all([
                    fetch(url + '?nocache=' + Math.random()),
                    fetch('https://api.github.com/repos/re-panza/lk_tool/commits?path=mondo327.json&page=1&per_page=1')
                ]);

                if (!respData.ok) throw new Error();
                db = await respData.json();

                // Estraiamo la data dell'ultimo commit
                let dataInfo = "Data non disponibile";
                if (respInfo.ok) {
                    const commitData = await respInfo.json();
                    if (commitData.length > 0) {
                        const dataGrezza = new Date(commitData[0].commit.committer.date);
                        dataInfo = dataGrezza.toLocaleString('it-IT', { 
                            day: '2-digit', month: '2-digit', year: 'numeric', 
                            hour: '2-digit', minute: '2-digit' 
                        });
                    }
                }
                
                stato.innerHTML = `‚úÖ Database Pronto (${db.length.toLocaleString()} castelli)<br>
                                   <small style="color:#aaa;">Ultima scansione: ${dataInfo}</small>`;
                stato.style.color = "#4caf50";
            } catch (err) {
                stato.innerHTML = "‚ùå Errore connessione database.";
                stato.style.color = "#f44336";
            }
        }

        loadDB();

        // 2. Funzione Cerca
        function cerca() {
            const input = document.getElementById('inputText').value;
            const resDiv = document.getElementById('risultati');
            
            // Regex per trovare l'ID (cerca "player?" seguito da numeri)
            const matchID = input.match(/player\?(\d+)/);
            
            // Regex opzionale per trovare il nome (prende tutto ci√≤ che c'√® dopo "Nome giocatore:")
            // Se non lo trova nel testo incollato, useremo "Giocatore" generico
            const matchNome = input.match(/Nome giocatore:\s*(.*?)(\n|$)/);
            const nomeGiocatore = matchNome ? matchNome[1].trim() : "Giocatore sconosciuto";

            if (!matchID) {
                alert("‚ö†Ô∏è Link non valido! Assicurati di aver incollato il link del profilo (l+k://player?...)");
                return;
            }

            const idCercato = matchID[1]; // Teniamo come stringa per sicurezza
            
            // Filtra il database
            // String(c.p) assicura che confrontiamo testo con testo
            const castelliTrovati = db.filter(c => String(c.p) === idCercato);

            if (castelliTrovati.length === 0) {
                resDiv.innerHTML = `<p style="text-align:center;">Nessun castello trovato per l'ID <b>${idCercato}</b>.<br><small>Prova ad attendere il prossimo aggiornamento dello scanner.</small></p>`;
                return;
            }

            // Generazione HTML Risultati
            let html = `<div style="text-align:center; margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:10px;">
                            <h3 style="margin:0; color:#fff;">${nomeGiocatore}</h3>
                            <small style="color:#aaa;">ID: ${idCercato} ‚Ä¢ Castelli: ${castelliTrovati.length}</small>
                        </div>`;

            castelliTrovati.forEach(c => {
                // 1. Pulizia del nome
                let nomeVisuale = c.n ? c.n.trim() : "";
                
                // 2. Se il nome √® vuoto, determiniamo il tipo dall'habitat (c.t)
                if (nomeVisuale === "") {
                    let tipoHabitat = "";
                    switch(String(c.t)) {
                        case "1": tipoHabitat = "Castello"; break;
                        case "2": tipoHabitat = "Fortezza"; break;
                        case "3": tipoHabitat = "Citt√†"; break;
                        default: tipoHabitat = "Habitat"; break;
                    }
                    
                    // Gestione maschile/femminile per la dicitura "libero/a"
                    let dicitura = (tipoHabitat === "Citt√†" || tipoHabitat === "Fortezza") ? "libera" : "libero";
                    nomeVisuale = `${tipoHabitat} ${dicitura}`;
                }

                // 3. Creazione dei link
                const deepLinkVisual = `l+k://coordinates?${c.x},${c.y}&327`; 
                const deepLinkActive = `l+k://coordinate?${c.x}&${c.y}&327`;
                
                html += `
                    <div class="castello-card">
                        <span class="castello-nome">Nome: ${nomeVisuale}</span>
                        <a href="${deepLinkActive}" class="castello-link">${deepLinkVisual}</a>
                    </div>
                `;
            });
            resDiv.innerHTML = html;
        }
    </script>
</body>
</html>
