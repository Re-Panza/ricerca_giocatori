<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Giocatore - L&K</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #eee; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; background: #2a2a2a; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { color: #ffcc00; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; background: #333; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; background: #ffcc00; color: #000; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #e6b800; }
        #risultati { margin-top: 20px; }
        .castello-item { background: #383838; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid #ffcc00; }
        .castello-item a { color: #00ccff; text-decoration: none; font-weight: bold; }
        .info-player { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ricerca Intelligence</h2>
    <p style="font-size: 0.9em; color: #bbb;">Incolla il link del profilo (es: l+k://player?605&327)</p>
    
    <input type="text" id="linkInput" placeholder="l+k://player?ID&MONDO">
    <button onclick="analizza()">Cerca Castelli</button>

    <div id="risultati"></div>
</div>

<script>
async function analizza() {
    const input = document.getElementById('linkInput').value;
    const divRisultati = document.getElementById('risultati');
    
    // Estrae l'ID dal link l+k://player?605&327
    const regex = /player\?(\d+)/;
    const match = input.match(regex);

    if (!match) {
        divRisultati.innerHTML = "<p style='color:red;'>Link non valido! Incolla il link profilo del gioco.</p>";
        return;
    }

    const playerID = parseInt(match[1]);
    divRisultati.innerHTML = "<p>üîç Ricerca in corso nel database...</p>";

    try {
        // Indirizzo preciso del tuo file JSON sulla repo lk_tool
        const urlJSON = 'https://re-panza.github.io/lk_tool/mondo327.json?v=' + Date.now(); 
        
        const risposta = await fetch(urlJSON);
        if (!risposta.ok) throw new Error("File non trovato");
        
        const dati = await risposta.json();

        // Filtra i castelli che hanno l'ID giocatore corrispondente
        const castelliTrovati = dati.filter(c => c.p === playerID);

        if (castelliTrovati.length === 0) {
            divRisultati.innerHTML = `<p>Nessun castello trovato per l'ID <b>${playerID}</b> nel database attuale.</p>`;
            return;
        }

        // Costruisce la lista dei risultati
        let html = `<div class="info-player"><h3>Trovati ${castelliTrovati.length} castelli</h3></div>`;
        
        castelliTrovati.forEach(c => {
            // Crea il link che apre direttamente il gioco alle coordinate
            const deepLink = `l+k://coordinate?${c.x}&${c.y}&327`;
            html += `
                <div class="castello-item">
                    <b style="color:#ffcc00;">${c.n}</b><br>
                    <small>Coordinate:</small> <a href="${deepLink}">${c.x}, ${c.y}</a>
                </div>
            `;
        });

        divRisultati.innerHTML = html;

    } catch (errore) {
        divRisultati.innerHTML = "<p style='color:red;'>Errore: Impossibile leggere il database. Verifica che il file mondo327.json sia presente in lk_tool.</p>";
        console.error(errore);
    }
}
</script>
