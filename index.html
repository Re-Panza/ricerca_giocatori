<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>L&K Scanner 327</title>
    <style>
        body { background-color: #111 !important; color: #fff !important; font-family: sans-serif; text-align: center; padding: 20px; }
        #main-box { max-width: 450px; margin: 0 auto; background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; display: block !important; }
        input { width: 80%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #555; background: #333; color: white; }
        button { width: 85%; padding: 12px; background: #ffcc00; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; color: black; }
        .info { margin: 15px 0; font-size: 0.9em; color: #aaa; }
        .castello { background: #333; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #ffcc00; text-align: left; }
        a { color: #00ccff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="main-box">
        <h2>Scanner Mondo 327</h2>
        <div id="stato" class="info">In attesa del database...</div>
        
        <input type="text" id="inputLink" placeholder="Incolla link profilo qui">
        <button onclick="cerca()">TROVA CASTELLI</button>

        <div id="risultati" style="margin-top:20px;"></div>
    </div>

    <script>
        // Log per vedere se il JS parte
        console.log("Script avviato");
        
        let db = [];

        async function carica() {
            const stato = document.getElementById('stato');
            try {
                const r = await fetch('https://re-panza.github.io/lk_tool/mondo327.json');
                if (!r.ok) throw new Error();
                db = await r.json();
                stato.innerHTML = "‚úÖ Database Pronto: " + db.length + " castelli";
                stato.style.color = "#00ff00";
            } catch (e) {
                stato.innerHTML = "‚ùå Errore: File JSON non trovato";
                stato.style.color = "#ff4444";
            }
        }

        carica();

        function cerca() {
            const link = document.getElementById('inputLink').value;
            const res = document.getElementById('risultati');
            const m = link.match(/player\?(\d+)/);
            
            if (!m) {
                alert("Link non valido!");
                return;
            }

            const id = parseInt(m[1]);
            const trovati = db.filter(c => c.p === id);

            if (trovati.length === 0) {
                res.innerHTML = "Nessun castello trovato per ID " + id;
                return;
            }

            let h = "<b>Trovati: " + trovati.length + "</b><br><br>";
            trovati.forEach(c => {
                const url = "l+k://coordinate?" + c.x + "&" + c.y + "&327";
                h += '<div class="castello"><b>' + c.n + '</b><br><a href="' + url + '">üìç Vai a ' + c.x + ':' + c.y + '</a></div>';
            });
            res.innerHTML = h;
        }
    </script>
</body>
</html>
