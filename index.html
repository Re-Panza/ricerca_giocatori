<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Giocatore - L&K Tool</title>
    <style>
        body { background-color: #0f172a; color: #e8eefc; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        .nav-home { display: inline-block; margin-bottom: 20px; color: #60a5fa; text-decoration: none; font-weight: bold; border: 1px solid #60a5fa; padding: 8px 15px; border-radius: 8px; transition: 0.3s; }
        .nav-home:hover { background: #60a5fa; color: #000; }
        .container { max-width: 600px; margin: 0 auto; background: #111c33; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); }
        h2 { color: #fff; margin-top: 0; }
        
        textarea { width: 100%; height: 100px; padding: 12px; margin: 15px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; box-sizing: border-box; resize: none; font-family: monospace; }
        textarea:focus { outline: none; border-color: #60a5fa; }
        
        /* Banner Errore */
        #errorBanner { display: none; background: #450a0a; color: #f87171; padding: 12px; border-radius: 10px; border: 1px solid #7f1d1d; margin-bottom: 15px; font-size: 0.9em; font-weight: bold; }

        .btn-cerca { width: 100%; padding: 15px; background: #60a5fa; border: none; font-weight: bold; font-size: 1.1em; border-radius: 12px; cursor: pointer; color: #fff; transition: 0.2s; margin-bottom: 10px; }
        .btn-export-box { display: flex; gap: 10px; margin: 20px 0; display: none; }
        .btn-exp { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-sel { background: #34d399; color: #064e3b; }
        .btn-all { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.1); }

        #stato { font-size: 0.9em; margin-bottom: 10px; color: #93a4c7; }
        
        .player-group { margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; text-align: left; }
        .player-header { background: rgba(255,255,255,0.03); color: #60a5fa; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .player-content { display: none; padding: 10px; background: rgba(0,0,0,0.1); border-top: 1px solid rgba(255,255,255,0.1); }
        .player-header.active + .player-content { display: block; }

        .castello-card { background: rgba(255,255,255,0.02); padding: 12px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #60a5fa; display: flex; align-items: center; gap: 12px; }
        .hab-check { width: 18px; height: 18px; cursor: pointer; accent-color: #34d399; }
        .castello-nome { font-weight: bold; color: #fff; display: block; }
        .castello-info { font-size: 0.85em; color: #93a4c7; }
        .castello-link { color: #60a5fa; text-decoration: none; font-family: monospace; font-size: 0.85em; display: block; margin-top: 5px; word-break: break-all; opacity: 0.8; }
        
        .footer { margin-top: 30px; font-size: 0.8em; color: #93a4c7; }
        .paypal-btn { color: #60a5fa; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <a href="https://re-panza.github.io/lk_tool/" class="nav-home">‚¨Ö Torna alla Home</a>

    <div class="container">
        <h2>üîç Intelligence Mondiale</h2>
        <div id="stato">Connessione al database...</div>
        
        <textarea id="inputText" placeholder="Esempio:&#10;Nome giocatore: Re Panza&#10;l+k://player?605&327"></textarea>
        
        <div id="errorBanner">‚ö†Ô∏è Errore: Incolla sia il 'Nome giocatore' che il link 'l+k://player'</div>
        
        <button class="btn-cerca" onclick="cerca()">AVVIA RICERCA</button>

        <div id="export-buttons" class="btn-export-box">
            <button class="btn-exp btn-sel" onclick="exportReport(true)">üì• SELEZIONATI</button>
            <button class="btn-exp btn-all" onclick="exportReport(false)">üì• TUTTI</button>
        </div>

        <div id="risultati"></div>
    </div>

    <div class="footer">
        L&K Tool by Re Panza<br><br>
        <a href="https://www.paypal.com/paypalme/filippocutrupi" target="_blank" class="paypal-btn">‚òï Offrimi un caff√® su PayPal</a>
    </div>

    <script>
        let db = [];

        async function loadDB() {
            const stato = document.getElementById('stato');
            try {
                const url = 'https://re-panza.github.io/lk_tool/mondo327.json?v=' + Date.now();
                const risposta = await fetch(url);
                db = await risposta.json();
                stato.innerHTML = `‚úÖ Database Pronto (${db.length.toLocaleString()} castelli)`;
            } catch (err) {
                stato.innerHTML = "‚ùå Errore caricamento database.";
            }
        }
        loadDB();

        function getTipoHabitat(t) {
            const tipo = String(t).trim();
            if (tipo === "0") return "Castello";
            if (tipo === "2") return "Fortezza";
            if (tipo === "4") return "Citt√†";
            return isNaN(tipo) ? tipo : "Metropoli";
        }

        function cerca() {
            const input = document.getElementById('inputText').value;
            const resDiv = document.getElementById('risultati');
            const exportDiv = document.getElementById('export-buttons');
            const errorBanner = document.getElementById('errorBanner');
            
            resDiv.innerHTML = ""; 
            errorBanner.style.display = "none";
            exportDiv.style.display = "none";

            // Controllo validit√† input
            if (!input.toLowerCase().includes("nome giocatore:") || !input.includes("l+k://player?")) {
                errorBanner.style.display = "block";
                return;
            }

            const chunks = input.split(/Nome giocatore:/i).filter(c => c.trim() !== "");
            
            chunks.forEach(chunk => {
                const linee = chunk.trim().split('\n');
                const nomePlayer = linee[0].trim();
                const idMatch = chunk.match(/player\?(\d+)/);

                if (idMatch) {
                    const pID = parseInt(idMatch[1]);
                    let castelli = db.filter(c => c.p === pID);
                    
                    // Ordinamento per punti decrescente
                    castelli.sort((a, b) => (b.pt || 0) - (a.pt || 0));

                    renderPlayerGroup(nomePlayer, castelli, resDiv);
                    exportDiv.style.display = "flex";
                }
            });
        }

        function renderPlayerGroup(nome, castelli, container) {
            const group = document.createElement('div');
            group.className = 'player-group';
            
            let itemsHtml = castelli.map((c, i) => {
                const tipo = getTipoHabitat(c.t);
                const coord = `${c.x}|${c.y}`;
                const link = `l+k://coordinates?${c.x},${c.y}&327`;
                const punti = (c.pt || 0).toLocaleString();
                
                return `
                    <div class="castello-card">
                        <input type="checkbox" class="hab-check" 
                               data-nome="${c.n}" data-coord="${coord}" 
                               data-link="${link}" data-tipo="${tipo}">
                        <div style="flex-grow:1">
                            <span class="castello-nome">${i+1}. ${c.n || 'Senza Nome'}</span>
                            <span class="castello-info"><b>${tipo}</b> ‚Ä¢ ${punti} pt</span>
                            <a href="${link}" class="castello-link">${link}</a>
                        </div>
                    </div>`;
            }).join('');

            group.innerHTML = `
                <div class="player-header" onclick="this.classList.toggle('active')">
                    <span>üë§ ${nome} (${castelli.length})</span>
                    <span>‚ñº</span>
                </div>
                <div class="player-content">
                    ${castelli.length > 0 ? itemsHtml : '<p style="padding:15px; color:#93a4c7; font-size:0.9em;">Nessun dato trovato per questo ID.</p>'}
                </div>
            `;
            container.appendChild(group);
        }

        function exportReport(soloSelezionati) {
            const checkboxes = document.querySelectorAll('.hab-check');
            let testo = "--- REPORT INTELLIGENCE L&K ---\n\n";
            let count = 0;

            checkboxes.forEach(cb => {
                if (!soloSelezionati || cb.checked) {
                    testo += `${cb.dataset.tipo}: ${cb.dataset.nome} (${cb.dataset.coord})\nLink: ${cb.dataset.link}\n\n`;
                    count++;
                }
            });

            if (count === 0) return alert("Nessuna selezione!");

            const blob = new Blob([testo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Report_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }
    </script>
</body>
</html>
